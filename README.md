# ИИ-агент с RAG Fusion и передачей запроса оператору поддержки

Этот проект реализует чат-бот поддержки с использованием LangChain с технологией RAG Fusion для поиска информации и возможностью передачи сложных запросов операторам-людям.

## Компоненты

1. **База знаний (knowledge_base.py):**
   - Обрабатывает загрузку, обработку и векторизацию документов
   - Предоставляет функциональность векторного поиска с использованием FAISS
   - Поддерживает различные форматы документов (текст, JSON)

2. **ИИ-агент (ai_agent.py):**
   - Реализует стратегию поиска RAG Fusion для улучшенных результатов
   - Поддерживает историю разговора
   - Включает определение необходимости передачи запроса оператору
   - Построен на LangChain и Ollama

3. **API сервер (api_server.py):**
   - Реализация FastAPI для обслуживания ИИ-агента
   - Эндпоинты для запросов к ИИ и загрузки файлов в базу знаний
   - Поддерживает управление разговорами и фоновую обработку данных

## Требования

- Python 3.9+
- [Ollama](https://ollama.ai/) установленный локально
- Модель Deepseek R1 7B, загруженная в Ollama

## Установка

1. **Установка зависимостей:**

```bash
pip install -r requirements.txt
```

2. **Установка и запуск Ollama:**

Следуйте инструкциям на [https://ollama.ai/](https://ollama.ai/) для установки Ollama.

3. **Загрузка модели Deepseek R1 7B:**

```bash
ollama pull deepseek-r1:7b
```

4. **Подготовка базы знаний:**

Создайте директорию для документов базы знаний:

```bash
mkdir -p knowledge
```

Добавьте текстовые документы, FAQ и другой контент для базы знаний в директорию `knowledge`.

5. **Создание векторного хранилища:**

```python
from knowledge_base import KnowledgeBase

# Инициализация базы знаний
kb = KnowledgeBase()

# Загрузка и обработка документов
documents = kb.load_and_process_documents(
    directory="./knowledge",
    files=["./faq.txt"],  # Добавьте конкретные файлы при необходимости
    json_files={"./data.json": ".content"}  # Добавьте JSON данные с экстракторами контента
)

# Создание векторного хранилища
kb.create_vector_store(documents, persist_directory="./vector_store")
```

## Использование

### Режим командной строки

Запустите ИИ-агента в режиме командной строки:

```bash
python ai_agent.py
```

Взаимодействуйте с агентом, вводя сообщения. Агент будет:
- Искать в базе знаний с использованием RAG Fusion
- Предоставлять ответы на основе релевантной информации
- Предлагать передачу запроса оператору, когда не может уверенно ответить

Специальные команды:
- Введите `exit` для выхода
- Введите `reset` для очистки истории разговора

### API сервер

Запустите API сервер:

```bash
python api_server.py
```

Это запустит FastAPI сервер на порту 8000 со следующими эндпоинтами:

- **POST /query**: Запрос к ИИ-агенту
  ```json
  {
    "query": "Как сбросить пароль?",
    "conversation_id": "опциональный-id-разговора",
    "reset_conversation": false
  }
  ```

- **POST /upload**: Загрузка файлов в базу знаний
  - Мультипарт-форма с файлами и опциональным параметром `rebuild_index`
  - Поддерживает файлы .txt, .pdf, .json, .md и .csv

- **GET /health**: Проверка статуса сервера

Доступ к интерактивной документации API через http://localhost:8000/docs

## Как работает RAG Fusion

RAG Fusion улучшает поиск следующим образом:
1. Генерирует несколько поисковых запросов на основе вопроса пользователя
2. Извлекает документы для каждого запроса
3. Объединяет результаты с помощью алгоритма обратного рангового слияния
4. Ранжирует документы для нахождения наиболее релевантной информации

Этот подход обеспечивает более полные и точные результаты по сравнению с поиском по одному запросу.

## Передача оператору

Агент определяет, когда он не может уверенно ответить на вопрос, и предлагает передать запрос оператору-человеку. Это срабатывает при:
- Отсутствии релевантной информации в базе знаний
- Сложных запросах за пределами возможностей агента
- Явных запросах на помощь от человека

В производственной среде вы можете интегрировать это с системой тикетов поддержки или платформой чата. 